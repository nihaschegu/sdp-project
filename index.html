<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MEDF-PS20 — Medical Consultation Prototype</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f4f6f8;color:#111}
  header{background:#0b5ed7;color:white;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  header strong{font-size:16px}
  header button{background:transparent;color:white;border:1px solid rgba(255,255,255,0.3);padding:6px 10px;border-radius:6px;cursor:pointer}
  main{padding:18px;max-width:1100px;margin:18px auto}
  .card{background:white;border-radius:10px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin:12px 0}
  input,select,textarea,button{font-size:15px;padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;margin-top:8px;box-sizing:border-box}
  button{background:#0b5ed7;color:white;border:none;cursor:pointer;transition:.3s}
  button:hover{background:#094ab0}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  .muted{color:#6b7280;font-size:13px}
  .small{font-size:13px}
  .danger{background:#ffe6e6;color:#9b1c1c}
  .success{background:#e6ffef;color:#0b6b2a}
  @media(max-width:700px){.row{flex-direction:column}}
</style>
</head>
<body>
<header>
  <strong>MEDF-PS20 — Medical Consultation Prototype</strong>
  <button onclick="logout()">Logout</button>
</header>

<main>

  <!-- REGISTER -->
  <section id="register" class="card">
    <h3>Create Account</h3>
    <input id="regName" placeholder="Full name" />
    <input id="regEmail" type="email" placeholder="Email" />
    <input id="regPassword" type="password" placeholder="Password" />
    <select id="regRole">
      <option value="patient">Patient</option>
      <option value="doctor">Doctor</option>
      <option value="pharmacist">Pharmacist</option>
      <option value="admin">Admin</option>
    </select>
    <button onclick="registerUser()">Register</button>
    <p class="muted" style="text-align:center;margin-top:10px">
      Already have an account? <a href="#" onclick="showSection('login')">Login here</a>
    </p>
  </section>

  <!-- LOGIN -->
  <section id="login" class="card" style="display:none">
    <h3>Sign in</h3>
    <input id="loginEmail" placeholder="Email" type="email" />
    <input id="loginPassword" placeholder="Password" type="password" />
    <select id="loginRole">
      <option value="patient">Patient</option>
      <option value="doctor">Doctor</option>
      <option value="admin">Admin</option>
      <option value="pharmacist">Pharmacist</option>
    </select>
    <button onclick="login()">Login</button>
    <p class="muted" style="text-align:center;margin-top:10px">
      Don’t have an account? <a href="#" onclick="showSection('register')">Register</a>
    </p>
  </section>

  <!-- PATIENT -->
  <section id="patient" class="card" style="display:none">
    <h3>Patient Dashboard — <span id="patientName"></span></h3>
    <div class="row">
      <div style="flex:1">
        <h4>Book Appointment</h4>
        <label>Choose Doctor</label>
        <select id="selectDoctor"></select>
        <label>Date & Time</label>
        <input id="apptDate" type="datetime-local" />
        <label>Reason</label>
        <textarea id="apptReason" rows="3"></textarea>
        <button onclick="bookAppointment()">Proceed to Payment & Book</button>
      </div>
      <div style="flex:1">
        <h4>My Appointments</h4>
        <div id="patientAppts"></div>
      </div>
    </div>
  </section>

  <!-- DOCTOR -->
  <section id="doctor" class="card" style="display:none">
    <h3>Doctor Dashboard — <span id="doctorName"></span></h3>
    <div class="row">
      <div style="flex:1">
        <h4>Pending Appointments</h4>
        <div id="doctorPending"></div>
      </div>
      <div style="flex:1">
        <h4>Approved / History</h4>
        <div id="doctorHistory"></div>
      </div>
    </div>
  </section>

  <!-- PHARMACIST -->
  <section id="pharmacist" class="card" style="display:none">
    <h3>Pharmacist Dashboard — <span id="pharmacistName"></span></h3>
    <div id="prescriptionsList"></div>
  </section>

  <!-- ADMIN -->
  <section id="admin" class="card" style="display:none">
    <h3>Admin Dashboard</h3>
    <h4>Users</h4>
    <div id="adminUsers"></div>
    <h4 style="margin-top:12px">All Appointments</h4>
    <div id="adminAppts"></div>
  </section>

</main>

<script>
const DB_USERS_KEY='medf_users_v1',DB_APPTS_KEY='medf_appts_v1',DB_PRESC_KEY='medf_presc_v1'
function load(k){return JSON.parse(localStorage.getItem(k)||'[]')}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function uid(){return Math.random().toString(36).slice(2,10)}
function findUserByEmail(e){return load(DB_USERS_KEY).find(u=>u.email===e)}

;(function seed(){
  const users=load(DB_USERS_KEY)
  if(users.length===0){
    users.push({id:uid(),name:'Admin',email:'admin@medf.test',password:'admin',role:'admin'})
    users.push({id:uid(),name:'Dr. Alice',email:'alice@medf.test',password:'doctor',role:'doctor'})
    users.push({id:uid(),name:'Patient Bob',email:'bob@medf.test',password:'patient',role:'patient'})
    save(DB_USERS_KEY,users)
  }
  if(!localStorage.getItem(DB_APPTS_KEY))save(DB_APPTS_KEY,[])
  if(!localStorage.getItem(DB_PRESC_KEY))save(DB_PRESC_KEY,[])
})()

function showSection(id){
  document.querySelectorAll('main > section').forEach(s=>s.style.display='none')
  document.getElementById(id).style.display='block'
}

function registerUser(){
  const name=document.getElementById('regName').value.trim()
  const email=document.getElementById('regEmail').value.trim()
  const pass=document.getElementById('regPassword').value
  const role=document.getElementById('regRole').value
  if(!name||!email||!pass){alert('Please fill all fields');return}
  if(findUserByEmail(email)){alert('User already exists');return}
  const users=load(DB_USERS_KEY)
  users.push({id:uid(),name,email,password:pass,role})
  save(DB_USERS_KEY,users)
  alert('Registered successfully! You can now login.')
  showSection('login')
}

function login(){
  const email=document.getElementById('loginEmail').value.trim()
  const pass=document.getElementById('loginPassword').value
  const role=document.getElementById('loginRole').value
  const user=load(DB_USERS_KEY).find(u=>u.email===email&&u.password===pass&&u.role===role)
  if(!user){alert('Invalid credentials');return}
  sessionStorage.setItem('medf_current',JSON.stringify(user))
  showRoleDashboard(user.role)
}

function logout(){
  sessionStorage.removeItem('medf_current')
  showSection('login')
}

function getCurrent(){return JSON.parse(sessionStorage.getItem('medf_current')||'null')}

function showRoleDashboard(role){
  const user=getCurrent();if(!user)return showSection('login')
  if(role==='patient'){document.getElementById('patientName').innerText=user.name;populateDoctors();renderPatientAppts();showSection('patient')}
  else if(role==='doctor'){document.getElementById('doctorName').innerText=user.name;renderDoctorPending();renderDoctorHistory();showSection('doctor')}
  else if(role==='admin'){renderAdminUsers();renderAdminAppts();showSection('admin')}
  else if(role==='pharmacist'){document.getElementById('pharmacistName').innerText=user.name;renderPrescriptions();showSection('pharmacist')}
}

function populateDoctors(){
  const sel=document.getElementById('selectDoctor');sel.innerHTML=''
  const doctors=load(DB_USERS_KEY).filter(u=>u.role==='doctor')
  doctors.forEach(d=>{const opt=document.createElement('option');opt.value=d.id;opt.textContent=d.name+' ('+d.email+')';sel.appendChild(opt)})
}

function bookAppointment(){
  const user=getCurrent();if(!user)return alert('Login required')
  const doctorId=document.getElementById('selectDoctor').value
  const datetime=document.getElementById('apptDate').value
  const reason=document.getElementById('apptReason').value
  if(!doctorId||!datetime||!reason)return alert('Fill all fields')
  if(!confirm('Simulate payment of ₹500 and confirm booking?'))return
  const appts=load(DB_APPTS_KEY)
  const appt={id:uid(),patientId:user.id,doctorId,datetime,reason,status:'pending',paid:true,videoLink:null,prescriptionId:null,createdAt:Date.now()}
  appts.push(appt);save(DB_APPTS_KEY,appts)
  alert('Appointment booked. Await doctor approval.')
  renderPatientAppts();renderDoctorPending();renderAdminAppts()
}

function renderPatientAppts(){
  const user=getCurrent();if(!user)return
  const appts=load(DB_APPTS_KEY).filter(a=>a.patientId===user.id)
  const c=document.getElementById('patientAppts');c.innerHTML=''
  if(appts.length===0){c.innerHTML='<p class="muted">No appointments yet</p>';return}
  const t=document.createElement('table')
  t.innerHTML='<tr><th>Doctor</th><th>Date</th><th>Status</th><th>Action</th></tr>'
  appts.forEach(a=>{
    const d=load(DB_USERS_KEY).find(u=>u.id===a.doctorId)
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${d?d.name:'(deleted)'}</td><td>${new Date(a.datetime).toLocaleString()}</td><td>${a.status}</td><td>${a.videoLink?'<a href="'+a.videoLink+'" target="_blank">Join Call</a>':''} ${a.prescriptionId?'<button onclick="viewPrescription(\''+a.prescriptionId+'\')">View Rx</button>':''}</td>`
    t.appendChild(tr)
  });c.appendChild(t)
}

function renderDoctorPending(){
  const user=getCurrent();if(!user)return
  const appts=load(DB_APPTS_KEY).filter(a=>a.doctorId===user.id&&a.status==='pending')
  const c=document.getElementById('doctorPending');c.innerHTML=''
  if(appts.length===0){c.innerHTML='<p class="muted">No pending appointments</p>';return}
  appts.forEach(a=>{
    const p=load(DB_USERS_KEY).find(u=>u.id===a.patientId)
    const d=document.createElement('div');d.className='card small'
    d.innerHTML=`<strong>${p?p.name:'(patient)'} — ${new Date(a.datetime).toLocaleString()}</strong><p class="muted">${a.reason}</p>`
    const b=document.createElement('button');b.textContent='Approve & Send Video Link';b.onclick=()=>approveAndSend(a.id)
    d.appendChild(b);c.appendChild(d)
  })
}

function approveAndSend(id){
  const appts=load(DB_APPTS_KEY);const a=appts.find(x=>x.id===id);if(!a)return
  a.status='approved';a.videoLink='https://meet.example.com/'+uid();save(DB_APPTS_KEY,appts)
  alert('Approved. Video link: '+a.videoLink)
  renderDoctorPending();renderDoctorHistory();renderPatientAppts();renderAdminAppts()
}

function renderDoctorHistory(){
  const user=getCurrent();if(!user)return
  const appts=load(DB_APPTS_KEY).filter(a=>a.doctorId===user.id&&(a.status==='approved'||a.status==='completed'))
  const c=document.getElementById('doctorHistory');c.innerHTML=''
  if(appts.length===0){c.innerHTML='<p class="muted">No approved/completed</p>';return}
  appts.forEach(a=>{
    const p=load(DB_USERS_KEY).find(u=>u.id===a.patientId)
    const d=document.createElement('div');d.className='card small'
    d.innerHTML=`<strong>${p?p.name:'(patient)'} — ${new Date(a.datetime).toLocaleString()}</strong><p class="muted">${a.reason}</p>`
    const b1=document.createElement('button');b1.textContent='Write Prescription';b1.onclick=()=>writePrescription(a.id)
    const b2=document.createElement('button');b2.textContent='Mark Completed';b2.style.marginLeft='8px';b2.onclick=()=>markCompleted(a.id)
    d.appendChild(b1);d.appendChild(b2);c.appendChild(d)
  })
}

function writePrescription(id){
  const text=prompt('Enter prescription:')
  if(!text)return
  const prescs=load(DB_PRESC_KEY);const pid=uid();prescs.push({id:pid,apptId:id,text,createdAt:Date.now(),dispensed:false});save(DB_PRESC_KEY,prescs)
  const appts=load(DB_APPTS_KEY);const a=appts.find(x=>x.id===id);if(a){a.prescriptionId=pid;save(DB_APPTS_KEY,appts)}
  alert('Prescription saved.');renderPrescriptions();renderPatientAppts();renderAdminAppts()
}

function markCompleted(id){
  const appts=load(DB_APPTS_KEY);const a=appts.find(x=>x.id===id);if(!a)return
  a.status='completed';save(DB_APPTS_KEY,appts);alert('Marked completed')
  renderDoctorHistory();renderPatientAppts();renderAdminAppts()
}

function renderPrescriptions(){
  const prescs=load(DB_PRESC_KEY);const c=document.getElementById('prescriptionsList');c.innerHTML=''
  if(prescs.length===0){c.innerHTML='<p class="muted">No prescriptions</p>';return}
  prescs.forEach(p=>{
    const a=load(DB_APPTS_KEY).find(x=>x.id===p.apptId)
    const patient=a?load(DB_USERS_KEY).find(u=>u.id===a.patientId):null
    const d=document.createElement('div');d.className='card small'
    d.innerHTML=`<strong>Rx for ${patient?patient.name:'(patient)'} — ${new Date(p.createdAt).toLocaleDateString()}</strong><p class="muted">${p.text}</p>`
    const b=document.createElement('button');b.textContent=p.dispensed?'Dispensed':'Mark Dispensed';b.onclick=()=>toggleDispensed(p.id)
    d.appendChild(b);c.appendChild(d)
  })
}

function toggleDispensed(id){
  const prescs=load(DB_PRESC_KEY);const p=prescs.find(x=>x.id===id);if(!p)return
  p.dispensed=!p.dispensed;save(DB_PRESC_KEY,prescs);renderPrescriptions();renderAdminAppts()
}

function renderAdminUsers(){
  const users=load(DB_USERS_KEY);const c=document.getElementById('adminUsers');c.innerHTML=''
  const t=document.createElement('table');t.innerHTML='<tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>'
  users.forEach(u=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td><button onclick="adminDeleteUser('${u.id}')">Delete</button></td>`;t.appendChild(tr)})
  c.appendChild(t)
}

function adminDeleteUser(id){
  if(!confirm('Delete user?'))return
  let users=load(DB_USERS_KEY).filter(u=>u.id!==id);save(DB_USERS_KEY,users)
  let appts=load(DB_APPTS_KEY).filter(a=>a.patientId!==id&&a.doctorId!==id);save(DB_APPTS_KEY,appts)
  let presc=load(DB_PRESC_KEY).filter(p=>load(DB_APPTS_KEY).find(a=>a.id===p.apptId));save(DB_PRESC_KEY,presc)
  renderAdminUsers();renderAdminAppts()
}

function renderAdminAppts(){
  const appts=load(DB_APPTS_KEY);const c=document.getElementById('adminAppts');c.innerHTML=''
  const t=document.createElement('table');t.innerHTML='<tr><th>Patient</th><th>Doctor</th><th>Date</th><th>Status</th><th>Paid</th></tr>'
  appts.forEach(a=>{
    const p=load(DB_USERS_KEY).find(u=>u.id===a.patientId)
    const d=load(DB_USERS_KEY).find(u=>u.id===a.doctorId)
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${p?p.name:''}</td><td>${d?d.name:''}</td><td>${new Date(a.datetime).toLocaleString()}</td><td>${a.status}</td><td>${a.paid?'Yes':'No'}</td>`
    t.appendChild(tr)
  })
  c.appendChild(t)
}

function viewPrescription(id){
  const p=load(DB_PRESC_KEY).find(x=>x.id===id)
  if(!p)return alert('Not found')
  alert('Prescription:\n'+p.text)
}

const u=getCurrent()
if(u)showRoleDashboard(u.role);else showSection('register')
</script>
</body>
</html>
